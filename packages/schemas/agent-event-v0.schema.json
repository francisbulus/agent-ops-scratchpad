{
  "$schema": "https://json-schema.org/draft/2020-12/schema",
  "$id": "https://agent-ops.local/schemas/agent-event-v0.schema.json",
  "title": "AgentOps Event v0",
  "description": "Canonical event contract for AgentOps observability, cost, and governance telemetry.",
  "type": "object",
  "additionalProperties": false,
  "required": [
    "event_version",
    "event_id",
    "event_type",
    "occurred_at",
    "tenant",
    "run",
    "trace"
  ],
  "properties": {
    "event_version": {
      "const": "v0"
    },
    "event_id": {
      "type": "string",
      "format": "uuid"
    },
    "event_type": {
      "type": "string",
      "enum": [
        "run.started",
        "run.completed",
        "run.failed",
        "step.started",
        "step.completed",
        "step.failed",
        "model.call.started",
        "model.call.completed",
        "model.call.failed",
        "tool.call.started",
        "tool.call.completed",
        "tool.call.failed",
        "budget.threshold_hit",
        "policy.decision",
        "alert.emitted"
      ]
    },
    "occurred_at": {
      "type": "string",
      "format": "date-time"
    },
    "ingested_at": {
      "type": "string",
      "format": "date-time"
    },
    "tenant": {
      "type": "object",
      "additionalProperties": false,
      "required": [
        "tenant_id",
        "workspace_id",
        "project_id"
      ],
      "properties": {
        "tenant_id": {
          "type": "string",
          "minLength": 1
        },
        "workspace_id": {
          "type": "string",
          "minLength": 1
        },
        "project_id": {
          "type": "string",
          "minLength": 1
        }
      }
    },
    "run": {
      "type": "object",
      "additionalProperties": false,
      "required": [
        "run_id",
        "agent_id",
        "workflow_id",
        "status"
      ],
      "properties": {
        "run_id": {
          "type": "string",
          "minLength": 1
        },
        "agent_id": {
          "type": "string",
          "minLength": 1
        },
        "workflow_id": {
          "type": "string",
          "minLength": 1
        },
        "workflow_version": {
          "type": "string"
        },
        "prompt_version": {
          "type": "string"
        },
        "status": {
          "type": "string",
          "enum": [
            "started",
            "success",
            "failure",
            "cancelled"
          ]
        },
        "started_at": {
          "type": "string",
          "format": "date-time"
        },
        "ended_at": {
          "type": "string",
          "format": "date-time"
        },
        "latency_ms": {
          "type": "integer",
          "minimum": 0
        }
      }
    },
    "step": {
      "type": "object",
      "additionalProperties": false,
      "required": [
        "step_id",
        "step_type",
        "status"
      ],
      "properties": {
        "step_id": {
          "type": "string",
          "minLength": 1
        },
        "step_type": {
          "type": "string",
          "enum": [
            "prompt",
            "tool",
            "router",
            "planner",
            "validator",
            "other"
          ]
        },
        "name": {
          "type": "string"
        },
        "status": {
          "type": "string",
          "enum": [
            "started",
            "success",
            "failure",
            "skipped"
          ]
        },
        "latency_ms": {
          "type": "integer",
          "minimum": 0
        }
      }
    },
    "model_call": {
      "type": "object",
      "additionalProperties": false,
      "required": [
        "model_call_id",
        "provider",
        "model"
      ],
      "properties": {
        "model_call_id": {
          "type": "string",
          "minLength": 1
        },
        "provider": {
          "type": "string",
          "minLength": 1
        },
        "model": {
          "type": "string",
          "minLength": 1
        },
        "request_id": {
          "type": "string"
        },
        "temperature": {
          "type": "number"
        },
        "max_output_tokens": {
          "type": "integer",
          "minimum": 0
        }
      }
    },
    "resource_usage": {
      "type": "object",
      "additionalProperties": false,
      "required": [
        "input_tokens",
        "output_tokens",
        "total_tokens"
      ],
      "properties": {
        "input_tokens": {
          "type": "integer",
          "minimum": 0
        },
        "output_tokens": {
          "type": "integer",
          "minimum": 0
        },
        "cached_tokens": {
          "type": "integer",
          "minimum": 0
        },
        "total_tokens": {
          "type": "integer",
          "minimum": 0
        },
        "tool_calls": {
          "type": "integer",
          "minimum": 0
        }
      }
    },
    "cost": {
      "type": "object",
      "additionalProperties": false,
      "required": [
        "cost_usd",
        "currency",
        "price_book_version"
      ],
      "properties": {
        "ledger_entry_id": {
          "type": "string"
        },
        "cost_usd": {
          "type": "number",
          "minimum": 0
        },
        "currency": {
          "type": "string",
          "const": "USD"
        },
        "price_book_version": {
          "type": "string",
          "minLength": 1
        },
        "cost_reason": {
          "type": "string",
          "enum": [
            "model_inference",
            "tool_execution",
            "correction"
          ]
        }
      }
    },
    "budget": {
      "type": "object",
      "additionalProperties": false,
      "required": [
        "budget_id",
        "scope",
        "period",
        "limit_usd",
        "enforcement",
        "result"
      ],
      "properties": {
        "budget_id": {
          "type": "string",
          "minLength": 1
        },
        "scope": {
          "type": "string",
          "enum": [
            "tenant",
            "workspace",
            "project",
            "agent"
          ]
        },
        "period": {
          "type": "string",
          "enum": [
            "hourly",
            "daily",
            "weekly",
            "monthly"
          ]
        },
        "limit_usd": {
          "type": "number",
          "minimum": 0
        },
        "spent_before_usd": {
          "type": "number",
          "minimum": 0
        },
        "spent_after_usd": {
          "type": "number",
          "minimum": 0
        },
        "enforcement": {
          "type": "string",
          "enum": [
            "soft",
            "hard"
          ]
        },
        "result": {
          "type": "string",
          "enum": [
            "within_limit",
            "soft_limit_exceeded",
            "hard_limit_blocked"
          ]
        }
      }
    },
    "policy": {
      "type": "object",
      "additionalProperties": false,
      "required": [
        "policy_id",
        "decision",
        "actor_type",
        "actor_id"
      ],
      "properties": {
        "policy_id": {
          "type": "string",
          "minLength": 1
        },
        "decision": {
          "type": "string",
          "enum": [
            "allow",
            "block",
            "escalate"
          ]
        },
        "reason": {
          "type": "string"
        },
        "actor_type": {
          "type": "string",
          "enum": [
            "user",
            "service",
            "system"
          ]
        },
        "actor_id": {
          "type": "string",
          "minLength": 1
        }
      }
    },
    "alert": {
      "type": "object",
      "additionalProperties": false,
      "required": [
        "alert_id",
        "type",
        "scope",
        "threshold",
        "current_value"
      ],
      "properties": {
        "alert_id": {
          "type": "string",
          "minLength": 1
        },
        "type": {
          "type": "string",
          "enum": [
            "spend_spike",
            "budget_threshold_hit",
            "success_rate_drop",
            "latency_breach",
            "error_rate_spike",
            "policy_violation_burst"
          ]
        },
        "scope": {
          "type": "string",
          "enum": [
            "tenant",
            "workspace",
            "project",
            "agent",
            "workflow"
          ]
        },
        "threshold": {
          "type": "number"
        },
        "current_value": {
          "type": "number"
        },
        "destination": {
          "type": "string"
        },
        "sent_at": {
          "type": "string",
          "format": "date-time"
        }
      }
    },
    "trace": {
      "type": "object",
      "additionalProperties": false,
      "required": [
        "trace_id",
        "span_id"
      ],
      "properties": {
        "trace_id": {
          "type": "string",
          "minLength": 1
        },
        "span_id": {
          "type": "string",
          "minLength": 1
        },
        "parent_span_id": {
          "type": [
            "string",
            "null"
          ]
        }
      }
    },
    "error": {
      "type": "object",
      "additionalProperties": false,
      "required": [
        "error_type",
        "retryable"
      ],
      "properties": {
        "error_type": {
          "type": "string",
          "minLength": 1
        },
        "error_code": {
          "type": "string"
        },
        "error_message_hash": {
          "type": "string"
        },
        "retryable": {
          "type": "boolean"
        }
      }
    },
    "attributes": {
      "type": "object",
      "additionalProperties": {
        "type": [
          "string",
          "number",
          "integer",
          "boolean",
          "null"
        ]
      }
    }
  },
  "allOf": [
    {
      "if": {
        "properties": {
          "event_type": {
            "enum": [
              "step.started",
              "step.completed",
              "step.failed",
              "model.call.started",
              "model.call.completed",
              "model.call.failed",
              "tool.call.started",
              "tool.call.completed",
              "tool.call.failed"
            ]
          }
        }
      },
      "then": {
        "required": [
          "step"
        ]
      }
    },
    {
      "if": {
        "properties": {
          "event_type": {
            "enum": [
              "model.call.started",
              "model.call.completed",
              "model.call.failed"
            ]
          }
        }
      },
      "then": {
        "required": [
          "model_call"
        ]
      }
    },
    {
      "if": {
        "properties": {
          "event_type": {
            "enum": [
              "run.completed",
              "run.failed",
              "model.call.completed",
              "model.call.failed"
            ]
          }
        }
      },
      "then": {
        "required": [
          "resource_usage",
          "cost"
        ]
      }
    },
    {
      "if": {
        "properties": {
          "event_type": {
            "const": "budget.threshold_hit"
          }
        }
      },
      "then": {
        "required": [
          "budget"
        ]
      }
    },
    {
      "if": {
        "properties": {
          "event_type": {
            "const": "policy.decision"
          }
        }
      },
      "then": {
        "required": [
          "policy"
        ]
      }
    },
    {
      "if": {
        "properties": {
          "event_type": {
            "const": "alert.emitted"
          }
        }
      },
      "then": {
        "required": [
          "alert"
        ]
      }
    },
    {
      "if": {
        "properties": {
          "event_type": {
            "enum": [
              "run.failed",
              "step.failed",
              "model.call.failed",
              "tool.call.failed"
            ]
          }
        }
      },
      "then": {
        "required": [
          "error"
        ]
      }
    }
  ]
}
